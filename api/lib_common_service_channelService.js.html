

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: lib/common/service/channelService.js | Pomelo API</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="">
        
            <img src="img/toast-ui.png" width="100%" height="100%">
        
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">Pomelo API</a></h1>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
    <div class="lnb-api hidden"><h3>Modules</h3><ul><li><a href="module-appUtils.html">appUtils</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:appUtils_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-appUtils.html#.defaultConfiguration">defaultConfiguration</a></li><li><a href="module-appUtils.html#.loadDefaultComponents">loadDefaultComponents</a></li><li><a href="module-appUtils.html#.optComponents">optComponents</a></li><li><a href="module-appUtils.html#.startByType">startByType</a></li><li><a href="module-appUtils.html#.stopComps">stopComps</a></li></ul></div></li><li><a href="module-ModuleUtil.html">ModuleUtil</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:ModuleUtil_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-ModuleUtil.html#.loadModules">loadModules</a></li><li><a href="module-ModuleUtil.html#.startModules">startModules</a></li><li><a href="module-ModuleUtil.html#.startModules">startModules</a></li></ul></div></li><li><a href="module-utils.html">utils</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:utils_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-utils.html#.arrayDiff">arrayDiff</a></li><li><a href="module-utils.html#.checkPort">checkPort</a></li><li><a href="module-utils.html#.endsWith">endsWith</a></li><li><a href="module-utils.html#.extends">extends</a></li><li><a href="module-utils.html#.format">format</a></li><li><a href="module-utils.html#.hasChineseChar">hasChineseChar</a></li><li><a href="module-utils.html#.headHandler">headHandler</a></li><li><a href="module-utils.html#.invokeCallback">invokeCallback</a></li><li><a href="module-utils.html#.isLocal">isLocal</a></li><li><a href="module-utils.html#.isObject">isObject</a></li><li><a href="module-utils.html#.loadCluster">loadCluster</a></li><li><a href="module-utils.html#.ping">ping</a></li><li><a href="module-utils.html#.size">size</a></li><li><a href="module-utils.html#.startsWith">startsWith</a></li><li><a href="module-utils.html#.unicodeToUtf8">unicodeToUtf8</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="Application.html">Application</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Application_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="Application.html#.STATE_INITED">STATE_INITED</a></li><li><a href="Application.html#.STATE_START">STATE_START</a></li><li><a href="Application.html#.STATE_STARTED">STATE_STARTED</a></li><li><a href="Application.html#.STATE_STOPED">STATE_STOPED</a></li><li><a href="Application.html#backendSessionService">backendSessionService</a></li><li><a href="Application.html#channelService">channelService</a></li><li><a href="Application.html#components">components</a></li><li><a href="Application.html#curServer">curServer</a></li><li><a href="Application.html#mode">mode</a></li><li><a href="Application.html#serverId">serverId</a></li><li><a href="Application.html#serverType">serverType</a></li><li><a href="Application.html#sessionService">sessionService</a></li><li><a href="Application.html#startTime">startTime</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="Application.html#.rpcInvoke">rpcInvoke</a></li><li><a href="Application.html#addCrons">addCrons</a></li><li><a href="Application.html#addServers">addServers</a></li><li><a href="Application.html#after">after</a></li><li><a href="Application.html#afterStart">afterStart</a></li><li><a href="Application.html#before">before</a></li><li><a href="Application.html#beforeStopHook">beforeStopHook</a></li><li><a href="Application.html#configure">configure</a></li><li><a href="Application.html#configureLogger">configureLogger</a></li><li><a href="Application.html#disable">disable</a></li><li><a href="Application.html#disabled">disabled</a></li><li><a href="Application.html#enable">enable</a></li><li><a href="Application.html#enabled">enabled</a></li><li><a href="Application.html#filter">filter</a></li><li><a href="Application.html#get">get</a></li><li><a href="Application.html#getBackendSessionService">getBackendSessionService</a></li><li><a href="Application.html#getBase">getBase</a></li><li><a href="Application.html#getChannelService">getChannelService</a></li><li><a href="Application.html#getCurServer">getCurServer</a></li><li><a href="Application.html#getMaster">getMaster</a></li><li><a href="Application.html#getRoutes">getRoutes</a></li><li><a href="Application.html#getServerById">getServerById</a></li><li><a href="Application.html#getServerFromConfig">getServerFromConfig</a></li><li><a href="Application.html#getServerId">getServerId</a></li><li><a href="Application.html#getServers">getServers</a></li><li><a href="Application.html#getServersByType">getServersByType</a></li><li><a href="Application.html#getServersFromConfig">getServersFromConfig</a></li><li><a href="Application.html#getServerType">getServerType</a></li><li><a href="Application.html#getServerTypes">getServerTypes</a></li><li><a href="Application.html#getSessionService">getSessionService</a></li><li><a href="Application.html#globalAfter">globalAfter</a></li><li><a href="Application.html#globalBefore">globalBefore</a></li><li><a href="Application.html#globalFilter">globalFilter</a></li><li><a href="Application.html#init">init</a></li><li><a href="Application.html#isBackend">isBackend</a></li><li><a href="Application.html#isFrontend">isFrontend</a></li><li><a href="Application.html#isMaster">isMaster</a></li><li><a href="Application.html#load">load</a></li><li><a href="Application.html#loadConfig">loadConfig</a></li><li><a href="Application.html#loadConfigBaseApp">loadConfigBaseApp</a></li><li><a href="Application.html#registerAdmin">registerAdmin</a></li><li><a href="Application.html#removeCrons">removeCrons</a></li><li><a href="Application.html#removeServers">removeServers</a></li><li><a href="Application.html#replaceServers">replaceServers</a></li><li><a href="Application.html#require">require</a></li><li><a href="Application.html#route">route</a></li><li><a href="Application.html#rpcAfter">rpcAfter</a></li><li><a href="Application.html#rpcBefore">rpcBefore</a></li><li><a href="Application.html#rpcFilter">rpcFilter</a></li><li><a href="Application.html#set">set</a></li><li><a href="Application.html#start">start</a></li><li><a href="Application.html#stop">stop</a></li><li><a href="Application.html#transaction">transaction</a></li><li><a href="Application.html#use">use</a></li></ul></div></li><li><a href="BackendSession.html">BackendSession</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BackendSession_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="BackendSession.html#bind">bind</a></li><li><a href="BackendSession.html#export">export</a></li><li><a href="BackendSession.html#get">get</a></li><li><a href="BackendSession.html#push">push</a></li><li><a href="BackendSession.html#pushAll">pushAll</a></li><li><a href="BackendSession.html#set">set</a></li><li><a href="BackendSession.html#unbind">unbind</a></li></ul></div></li><li><a href="BackendSessionService.html">BackendSessionService</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BackendSessionService_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="BackendSessionService.html#bind">bind</a></li><li><a href="BackendSessionService.html#get">get</a></li><li><a href="BackendSessionService.html#getByUid">getByUid</a></li><li><a href="BackendSessionService.html#kickBySid">kickBySid</a></li><li><a href="BackendSessionService.html#kickByUid">kickByUid</a></li><li><a href="BackendSessionService.html#push">push</a></li><li><a href="BackendSessionService.html#pushAll">pushAll</a></li><li><a href="BackendSessionService.html#unbind">unbind</a></li></ul></div></li><li><a href="BaseComponent.html">BaseComponent</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BaseComponent_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="BaseComponent.html#afterStart">afterStart</a></li><li><a href="BaseComponent.html#start">start</a></li><li><a href="BaseComponent.html#stop">stop</a></li></ul></div></li><li><a href="BaseCron.html">BaseCron</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BaseCron_sub"></div></li><li><a href="BaseFilter.html">BaseFilter</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BaseFilter_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="BaseFilter.html#after">after</a></li><li><a href="BaseFilter.html#before">before</a></li></ul></div></li><li><a href="BaseGameHandler.html">BaseGameHandler</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BaseGameHandler_sub"></div></li><li><a href="BaseGameRemote.html">BaseGameRemote</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BaseGameRemote_sub"></div></li><li><a href="BaseLifecycle.html">BaseLifecycle</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BaseLifecycle_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="BaseLifecycle.html#.afterStartAll">afterStartAll</a></li><li><a href="BaseLifecycle.html#.afterStartup">afterStartup</a></li><li><a href="BaseLifecycle.html#.beforeShutdown">beforeShutdown</a></li><li><a href="BaseLifecycle.html#.beforeStartup">beforeStartup</a></li></ul></div></li><li><a href="Channel.html">Channel</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Channel_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Channel.html#add">add</a></li><li><a href="Channel.html#destroy">destroy</a></li><li><a href="Channel.html#getMember">getMember</a></li><li><a href="Channel.html#getMembers">getMembers</a></li><li><a href="Channel.html#getUserAmount">getUserAmount</a></li><li><a href="Channel.html#leave">leave</a></li><li><a href="Channel.html#pushMessage">pushMessage</a></li></ul></div></li><li><a href="ChannelService.html">ChannelService</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ChannelService_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="ChannelService.html#broadcast">broadcast</a></li><li><a href="ChannelService.html#createChannel">createChannel</a></li><li><a href="ChannelService.html#destroyChannel">destroyChannel</a></li><li><a href="ChannelService.html#getChannel">getChannel</a></li><li><a href="ChannelService.html#pushMessageByUids">pushMessageByUids</a></li></ul></div></li><li><a href="ComponentDictionary.html">ComponentDictionary</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ComponentDictionary_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="ComponentDictionary.html#start">start</a></li></ul></div></li><li><a href="ComponentProtobuf.html">ComponentProtobuf</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ComponentProtobuf_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="ComponentProtobuf.html#stop">stop</a></li></ul></div></li><li><a href="ComponentProxy.html">ComponentProxy</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ComponentProxy_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="ComponentProxy.html#addServers">addServers</a></li><li><a href="ComponentProxy.html#afterStart">afterStart</a></li><li><a href="ComponentProxy.html#removeServers">removeServers</a></li><li><a href="ComponentProxy.html#replaceServers">replaceServers</a></li><li><a href="ComponentProxy.html#rpcInvoke">rpcInvoke</a></li><li><a href="ComponentProxy.html#start">start</a></li></ul></div></li><li><a href="ComponentPushScheduler.html">ComponentPushScheduler</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ComponentPushScheduler_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="ComponentPushScheduler.html#afterStart">afterStart</a></li><li><a href="ComponentPushScheduler.html#schedule">schedule</a></li><li><a href="ComponentPushScheduler.html#stop">stop</a></li></ul></div></li><li><a href="ComponentRemote.html">ComponentRemote</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ComponentRemote_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="ComponentRemote.html#start">start</a></li><li><a href="ComponentRemote.html#stop">stop</a></li></ul></div></li><li><a href="ComponentSession.html">ComponentSession</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ComponentSession_sub"></div></li><li><a href="Connection.html">Connection</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Connection_sub"></div></li><li><a href="ConnectionService.html">ConnectionService</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ConnectionService_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="ConnectionService.html#addLoginedUser">addLoginedUser</a></li><li><a href="ConnectionService.html#decreaseConnectionCount">decreaseConnectionCount</a></li><li><a href="ConnectionService.html#getConnectionInfo">getConnectionInfo</a></li><li><a href="ConnectionService.html#getStatisticsInfo">getStatisticsInfo</a></li><li><a href="ConnectionService.html#increaseConnectionCount">increaseConnectionCount</a></li><li><a href="ConnectionService.html#removeLoginedUser">removeLoginedUser</a></li><li><a href="ConnectionService.html#updateUserInfo">updateUserInfo</a></li></ul></div></li><li><a href="Connector.html">Connector</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Connector_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Connector.html#afterStart">afterStart</a></li><li><a href="Connector.html#start">start</a></li><li><a href="Connector.html#stop">stop</a></li></ul></div></li><li><a href="CountDownLatch.html">CountDownLatch</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="CountDownLatch_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="CountDownLatch.html#done">done</a></li></ul></div></li><li><a href="FilterHandlerSerial.html">FilterHandlerSerial</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="FilterHandlerSerial_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="FilterHandlerSerial.html#after">after</a></li><li><a href="FilterHandlerSerial.html#before">before</a></li></ul></div></li><li><a href="FilterHandlerTime.html">FilterHandlerTime</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="FilterHandlerTime_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="FilterHandlerTime.html#after">after</a></li><li><a href="FilterHandlerTime.html#before">before</a></li></ul></div></li><li><a href="FilterHandlerTimeout.html">FilterHandlerTimeout</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="FilterHandlerTimeout_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="FilterHandlerTimeout.html#after">after</a></li><li><a href="FilterHandlerTimeout.html#before">before</a></li></ul></div></li><li><a href="FilterHandlerTooBusy.html">FilterHandlerTooBusy</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="FilterHandlerTooBusy_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="FilterHandlerTooBusy.html#before">before</a></li></ul></div></li><li><a href="FilterRpcLog.html">FilterRpcLog</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="FilterRpcLog_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="FilterRpcLog.html#after">after</a></li><li><a href="FilterRpcLog.html#before">before</a></li></ul></div></li><li><a href="FilterToobusy.html">FilterToobusy</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="FilterToobusy_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="FilterToobusy.html#before">before</a></li></ul></div></li><li><a href="FrontendSession.html">FrontendSession</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="FrontendSession_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="FrontendSession.html#export">export</a></li></ul></div></li><li><a href="HandlerService.html">HandlerService</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="HandlerService_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="HandlerService.html#getHandler">getHandler</a></li><li><a href="HandlerService.html#handle">handle</a></li></ul></div></li><li><a href="hybridConnector.Connector.html">Connector</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="hybridConnector.Connector_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="hybridConnector.Connector.html#start">start</a></li></ul></div></li><li><a href="hybridConnector.Processor.html">Processor</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="hybridConnector.Processor_sub"></div></li><li><a href="hybridConnector.Socket.html">Socket</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="hybridConnector.Socket_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="hybridConnector.Socket.html#disconnect">disconnect</a></li><li><a href="hybridConnector.Socket.html#handshakeResponse">handshakeResponse</a></li><li><a href="hybridConnector.Socket.html#send">send</a></li><li><a href="hybridConnector.Socket.html#sendBatch">sendBatch</a></li><li><a href="hybridConnector.Socket.html#sendForce">sendForce</a></li><li><a href="hybridConnector.Socket.html#sendRaw">sendRaw</a></li></ul></div></li><li><a href="hybridConnector.Switcher.html">Switcher</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="hybridConnector.Switcher_sub"></div></li><li><a href="MasterComp.html">MasterComp</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="MasterComp_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="MasterComp.html#start">start</a></li><li><a href="MasterComp.html#stop">stop</a></li></ul></div></li><li><a href="Monitor.html">Monitor</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Monitor_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Monitor.html#start">start</a></li><li><a href="Monitor.html#stop">stop</a></li></ul></div></li><li><a href="MonitorComp.html">MonitorComp</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="MonitorComp_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="MonitorComp.html#start">start</a></li><li><a href="MonitorComp.html#stop">stop</a></li></ul></div></li><li><a href="MqttConnector.Adaptor.html">Adaptor</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="MqttConnector.Adaptor_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="MqttConnector.Adaptor.html#publish">publish</a></li></ul></div></li><li><a href="MqttConnector.Connector.html">Connector</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="MqttConnector.Connector_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="MqttConnector.Connector.html#start">start</a></li></ul></div></li><li><a href="MqttConnector.Socket.html">Socket</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="MqttConnector.Socket_sub"></div></li><li><a href="Pomelo.html">Pomelo</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Pomelo_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="Pomelo.html#components">components</a></li><li><a href="Pomelo.html#connectors">connectors</a></li><li><a href="Pomelo.html#events">events</a></li><li><a href="Pomelo.html#filters">filters</a></li><li><a href="Pomelo.html#pushSchedulers">pushSchedulers</a></li><li><a href="Pomelo.html#rpcFilters">rpcFilters</a></li><li><a href="Pomelo.html#version">version</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="Pomelo.html#createApp">createApp</a></li></ul></div></li><li><a href="Server.html">Server</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Server_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Server.html#addCrons">addCrons</a></li><li><a href="Server.html#globalHandle">globalHandle</a></li><li><a href="Server.html#handle">handle</a></li><li><a href="Server.html#removeCrons">removeCrons</a></li><li><a href="Server.html#start">start</a></li><li><a href="Server.html#stop">stop</a></li></ul></div></li><li><a href="ServerComp.html">ServerComp</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ServerComp_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="ServerComp.html#afterStart">afterStart</a></li><li><a href="ServerComp.html#globalHandle">globalHandle</a></li><li><a href="ServerComp.html#handle">handle</a></li><li><a href="ServerComp.html#start">start</a></li><li><a href="ServerComp.html#stop">stop</a></li></ul></div></li><li><a href="ServiceFilter.html">ServiceFilter</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ServiceFilter_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="ServiceFilter.html#after">after</a></li><li><a href="ServiceFilter.html#afterFilter">afterFilter</a></li><li><a href="ServiceFilter.html#before">before</a></li><li><a href="ServiceFilter.html#beforeFilter">beforeFilter</a></li></ul></div></li><li><a href="Session.html">Session</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Session_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Session.html#bind">bind</a></li><li><a href="Session.html#closed">closed</a></li><li><a href="Session.html#get">get</a></li><li><a href="Session.html#remove">remove</a></li><li><a href="Session.html#send">send</a></li><li><a href="Session.html#sendBatch">sendBatch</a></li><li><a href="Session.html#set">set</a></li><li><a href="Session.html#unbind">unbind</a></li></ul></div></li><li><a href="SessionService.html">SessionService</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="SessionService_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="SessionService.html#bind">bind</a></li><li><a href="SessionService.html#create">create</a></li><li><a href="SessionService.html#forEachBindedSession">forEachBindedSession</a></li><li><a href="SessionService.html#forEachSession">forEachSession</a></li><li><a href="SessionService.html#get">get</a></li><li><a href="SessionService.html#getByUid">getByUid</a></li><li><a href="SessionService.html#getClientAddressBySessionId">getClientAddressBySessionId</a></li><li><a href="SessionService.html#getSessionsCount">getSessionsCount</a></li><li><a href="SessionService.html#import">import</a></li><li><a href="SessionService.html#importAll">importAll</a></li><li><a href="SessionService.html#kick">kick</a></li><li><a href="SessionService.html#kickBySessionId">kickBySessionId</a></li><li><a href="SessionService.html#remove">remove</a></li><li><a href="SessionService.html#sendMessage">sendMessage</a></li><li><a href="SessionService.html#sendMessageByUid">sendMessageByUid</a></li><li><a href="SessionService.html#unbind">unbind</a></li></ul></div></li><li><a href="SioConnector.Connector.html">Connector</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="SioConnector.Connector_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="SioConnector.Connector.html#.decode">decode</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="SioConnector.Connector.html#start">start</a></li><li><a href="SioConnector.Connector.html#stop">stop</a></li></ul></div></li><li><a href="SioConnector.Socket.html">Socket</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="SioConnector.Socket_sub"></div></li><li><a href="UdpConnector.Connector.html">Connector</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="UdpConnector.Connector_sub"></div></li><li><a href="UdpConnector.Socket.html">Socket</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="UdpConnector.Socket_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="UdpConnector.Socket.html#send">send</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3>Namespaces</h3><ul><li><a href="hybridConnector.html">hybridConnector</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="hybridConnector_sub"></div></li><li><a href="MqttConnector.html">MqttConnector</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="MqttConnector_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="MqttConnector.html#.module.exports.codes">module.exports.codes</a></li><li><a href="MqttConnector.html#.module.exports.types">module.exports.types</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="MqttConnector.html#.module.exports.publish">module.exports.publish</a></li></ul></div></li><li><a href="SexPomelo.html">SexPomelo</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="SexPomelo_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="SexPomelo.html#Application">Application</a></li><li><a href="SexPomelo.html#BaseComponent">BaseComponent</a></li><li><a href="SexPomelo.html#BaseFilter">BaseFilter</a></li><li><a href="SexPomelo.html#Cron">Cron</a></li><li><a href="SexPomelo.html#GameHandler">GameHandler</a></li><li><a href="SexPomelo.html#GameRemote">GameRemote</a></li><li><a href="SexPomelo.html#Lifecycle">Lifecycle</a></li></ul></div></li><li><a href="SioConnector.html">SioConnector</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="SioConnector_sub"></div></li><li><a href="UdpConnector.html">UdpConnector</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="UdpConnector_sub"></div></li></ul></div><div class="lnb-api hidden"><h3>Interfaces</h3><ul><li><a href="Component.html">Component</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Component_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Component.html#afterStart">afterStart</a></li><li><a href="Component.html#start">start</a></li><li><a href="Component.html#stop">stop</a></li></ul></div></li><li><a href="Filter.html">Filter</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Filter_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Filter.html#after">after</a></li><li><a href="Filter.html#before">before</a></li></ul></div></li><li><a href="LifeCycle.html">LifeCycle</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="LifeCycle_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="LifeCycle.html#afterStartAll">afterStartAll</a></li><li><a href="LifeCycle.html#afterStartup">afterStartup</a></li><li><a href="LifeCycle.html#beforeShutdown">beforeShutdown</a></li><li><a href="LifeCycle.html#beforeStartup">beforeStartup</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3>Global</h3><ul><li class="hidden"><a href="global.html#AutoFilters">AutoFilters</a></li><li class="hidden"><a href="global.html#AutoRpcFilters">AutoRpcFilters</a></li><li><a href="global.html#Command">Command</a></li><li><a href="global.html#configure">configure</a></li><li><a href="global.html#create">create</a></li><li class="hidden"><a href="global.html#DefaultComponents">DefaultComponents</a></li><li class="hidden"><a href="global.html#DefaultConnectors">DefaultConnectors</a></li><li class="hidden"><a href="global.html#ServerInfo">ServerInfo</a></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";

const countDownLatch = require('../../util/countDownLatch');
const utils = require('../../util/utils');
const ChannelRemote = require('../remote/frontend/channelRemote');
const logger = require('@sex-pomelo/sex-pomelo-logger').getLogger('pomelo', __filename);

/*!
 * constant
 */
const ST_INITED = 0;
const ST_DESTROYED = 1;

/**
 * Create and maintain channels for server local.
 *
 * ChannelService is created by channel component which is a default loaded
 * component of pomelo and channel service would be accessed by `app.get('channelService')`.
 *
 * @class
 * @constructor
 */
let ChannelService = function(app, opts) {
  opts = opts || {};
  this.app = app;
  this.channels = {};
  this.prefix = opts.prefix;
  this.store = opts.store;
  this.broadcastFilter = opts.broadcastFilter;
  this.channelRemote = new ChannelRemote(app);
};

module.exports = ChannelService;


ChannelService.prototype.start = function(cb) {
  restoreChannel(this, cb);
};



/**
 * Create channel with name.
 *
 * @param {String} name channel's name
 * @memberOf ChannelService
 */
ChannelService.prototype.createChannel = function(name) {
  if(this.channels[name]) {
    return this.channels[name];
  }

  let c = new Channel(name, this);
  addToStore(this, genKey(this), genKey(this, name));
  this.channels[name] = c;
  return c;
};

/**
 * Get channel by name.
 *
 * @param {String} name channel's name
 * @param {Boolean} create if true, create channel
 * @return {Channel}
 * @memberOf ChannelService
 */
ChannelService.prototype.getChannel = function(name, create) {
  let channel = this.channels[name];
  if(!channel &amp;&amp; !!create) {
    channel = this.channels[name] = new Channel(name, this);
    addToStore(this, genKey(this), genKey(this, name));
  }
  return channel;
};

/**
 * Destroy channel by name.
 *
 * @param {String} name channel name
 * @memberOf ChannelService
 */
ChannelService.prototype.destroyChannel = function(name) {
  delete this.channels[name];
  removeFromStore(this, genKey(this), genKey(this, name));
  removeAllFromStore(this, genKey(this, name));
};

/**
 * Push message by uids.
 * Group the uids by group. ignore any uid if sid not specified.
 *
 * @param {String} route message route
 * @param {Object} msg message that would be sent to client
 * @param {Array} uids the receiver info list, [{uid: userId, sid: frontendServerId}]
 * @param {Object} opts user-defined push options, optional 
 * @param {Function} cb cb(err)
 * @memberOf ChannelService
 */
ChannelService.prototype.pushMessageByUids = function(route, msg, uids, opts, cb) {
  if(typeof route !== 'string') {
    cb = opts;
    opts = uids;
    uids = msg;
    msg = route;
    route = msg.route;
  }

  if(!cb &amp;&amp; typeof opts === 'function') {
    cb = opts;
    opts = {};
  }

  if(!uids || uids.length === 0) {
    utils.invokeCallback(cb, new Error('uids should not be empty'));
    return;
  }
  let groups = {}, record;
  for(let i=0, l=uids.length; i&lt;l; i++) {
    record = uids[i];
    add(record.uid, record.sid, groups);
  }

  sendMessageByGroup(this, route, msg, groups, opts, cb);
};

/**
 * Broadcast message to all the connected clients.
 *
 * @param  {String}   stype      frontend server type string
 * @param  {String}   route      route string
 * @param  {Object}   msg        message
 * @param  {Object}   opts       user-defined broadcast options, optional
 *                               opts.binded: push to binded sessions or all the sessions
 *                               opts.filterParam: parameters for broadcast filter.
 * @param  {Function} cb         callback
 * @memberOf ChannelService
 */
ChannelService.prototype.broadcast = function(stype, route, msg, opts, cb) {
  let app = this.app;
  let namespace = 'sys';
  let service = 'channelRemote';
  let method = 'broadcast';
  let servers = app.getServersByType(stype);

  if(!servers || servers.length === 0) {
    // server list is empty
    utils.invokeCallback(cb);
    return;
  }

  let count = servers.length;
  let successFlag = false;

  let latch = countDownLatch.createCountDownLatch(count, function() {
    if(!successFlag) {
      utils.invokeCallback(cb, new Error('broadcast fails'));
      return;
    }
    utils.invokeCallback(cb, null);
  });

  let genCB = function(serverId) {
    return function(err) {
      if(err) {
        logger.error('[broadcast] fail to push message to serverId: ' + serverId + ', err:' + err.stack);
        latch.done();
        return;
      }
      successFlag = true;
      latch.done();
    };
  };

  let self = this;
  let sendMessage = function(serverId) {
    return (function() {
      if(serverId === app.serverId) {
        self.channelRemote[method](route, msg, opts, genCB());
      } else {
        app.rpcInvoke(serverId, {namespace: namespace, service: service,
          method: method, args: [route, msg, opts]}, genCB(serverId));
      }
    }());
  };

  opts = {type: 'broadcast', userOptions: opts || {}};

  // for compatiblity 
  opts.isBroadcast = true;
  if(opts.userOptions) {
    opts.binded = opts.userOptions.binded;
    opts.filterParam = opts.userOptions.filterParam;
  }

  for(let i=0, l=count; i&lt;l; i++) {
    sendMessage(servers[i].id);
  }
};

/**
 * Channel maintains the receiver collection for a subject. You can
 * add users into a channel and then broadcast message to them by channel.
 *
 * @class channel
 * @constructor
 */
let Channel = function(name, service) {
  this.name = name;
  this.groups = {};       // group map for uids. key: sid, value: [uid]
  this.records = {};      // member records. key: uid
  this.__channelService__ = service;
  this.state = ST_INITED;
  this.userAmount =0;
};

/**
 * Add user to channel.
 *
 * @param {Number} uid user id
 * @param {String} sid frontend server id which user has connected to
 */
Channel.prototype.add = function(uid, sid) {
  if(this.state > ST_INITED) {
    return false;
  } else {
    let res = add(uid, sid, this.groups);
    if(res) {
      this.records[uid] = {sid: sid, uid: uid};
      this.userAmount =this.userAmount+1;
    }
    addToStore(this.__channelService__, genKey(this.__channelService__, this.name), genValue(sid, uid));
    return res;
  }
};

/**
 * Remove user from channel.
 *
 * @param {Number} uid user id
 * @param {String} sid frontend server id which user has connected to.
 * @return [Boolean] true if success or false if fail
 */
Channel.prototype.leave = function(uid, sid) {
  if(!uid || !sid) {
    return false;
  }
  let res = deleteFrom(uid, sid, this.groups[sid]);
  if(res){
    delete this.records[uid];
    this.userAmount = this.userAmount-1;
  }
  if(this.userAmount&lt;0) this.userAmount=0;//robust
  removeFromStore(this.__channelService__, genKey(this.__channelService__, this.name), genValue(sid, uid));
  if(this.groups[sid] &amp;&amp; this.groups[sid].length === 0) {
    delete this.groups[sid];
  }
  return res;
};
/**
 * Get channel UserAmount in a channel.

 *
 * @return {number } channel member amount
 */
Channel.prototype.getUserAmount = function() {
  return this.userAmount;
};

/**
 * Get channel members.
 *
 * &lt;b>Notice:&lt;/b> Heavy operation.
 *
 * @return {Array} channel member uid list
 */
Channel.prototype.getMembers = function() {
  let res = [], groups = this.groups;
  let group, i, l;
  for(let sid in groups) {
    group = groups[sid];
    for(i=0, l=group.length; i&lt;l; i++) {
      res.push(group[i]);
    }
  }
  return res;
};

/**
 * Get Member info.
 *
 * @param  {String} uid user id
 * @return {Object} member info
 */
Channel.prototype.getMember = function(uid) {
  return this.records[uid];
};

/**
 * Destroy channel.
 */
Channel.prototype.destroy = function() {
  this.state = ST_DESTROYED;
  this.__channelService__.destroyChannel(this.name);
};

/**
 * Push message to all the members in the channel
 *
 * @param {String} route message route
 * @param {Object} msg message that would be sent to client
 * @param {Object} opts user-defined push options, optional
 * @param {Function} cb callback function
 */
Channel.prototype.pushMessage = function(route, msg, opts, cb) {
  if(this.state !== ST_INITED) {
    utils.invokeCallback(new Error('channel is not running now'));
    return;
  }

  if(typeof route !== 'string') {
    cb = opts;
    opts = msg;
    msg = route;
    route = msg.route;
  }

  if(!cb &amp;&amp; typeof opts === 'function') {
    cb = opts;
    opts = {};
  }

  sendMessageByGroup(this.__channelService__, route, msg, this.groups, opts, cb);
};

/**
 * add uid and sid into group. ignore any uid that uid not specified.
 * @access private
 * @param uid user id
 * @param sid server id
 * @param groups {Object} grouped uids, , key: sid, value: [uid]
 */
let add = function(uid, sid, groups) {
  if(!sid) {
    logger.warn('ignore uid %j for sid not specified.', uid);
    return false;
  }

  let group = groups[sid];
  if(!group) {
    group = [];
    groups[sid] = group;
  }

  group.push(uid);
  return true;
};

/**
 * delete element from array
 * @access private
 */
let deleteFrom = function(uid, sid, group) {
  if(!uid || !sid || !group) {
    return false;
  }

  for(let i=0, l=group.length; i&lt;l; i++) {
    if(group[i] === uid) {
      group.splice(i, 1);
      return true;
    }
  }

  return false;
};

/**
 * push message by group
 * @access private
 * @param route {String} route route message
 * @param msg {Object} message that would be sent to client
 * @param groups {Object} grouped uids, , key: sid, value: [uid]
 * @param opts {Object} push options
 * @param cb {Function} cb(err)
 *
 * @api private
 */
let sendMessageByGroup = function(channelService, route, msg, groups, opts, cb) {
  let app = channelService.app;
  let namespace = 'sys';
  let service = 'channelRemote';
  let method = 'pushMessage';
  let count = utils.size(groups);
  let successFlag = false;
  let failIds = [];

  logger.debug('[%s] channelService sendMessageByGroup route: %s, msg: %j, groups: %j, opts: %j', app.serverId, route, msg, groups, opts);
  if(count === 0) {
    // group is empty
    utils.invokeCallback(cb);
    return;
  }

  let latch = countDownLatch.createCountDownLatch(count, function() {
    if(!successFlag) {
      utils.invokeCallback(cb, new Error('all uids push message fail'));
      return;
    }
    utils.invokeCallback(cb, null, failIds);
  });

  let rpcCB = function(serverId) {
    return function(err, fails) {
      if(err) {
        logger.error('[pushMessage] fail to dispatch msg to serverId: ' + serverId + ', err:' + err.stack);
        latch.done();
        return;
      }
      if(fails) {
        failIds = failIds.concat(fails);
      }
      successFlag = true;
      latch.done();
    };
  };

  opts = {type: 'push', userOptions: opts || {}};
  // for compatiblity
  opts.isPush = true;
  
  let sendMessage = function(sid) {
    return (function() {
      if(sid === app.serverId) {
        channelService.channelRemote[method](route, msg, groups[sid], opts, rpcCB(sid));
      } else {
        app.rpcInvoke(sid, {namespace: namespace, service: service,
          method: method, args: [route, msg, groups[sid], opts]}, rpcCB(sid));
      }
    })();
  };

  let group;
  for(let sid in groups) {
    group = groups[sid];
    if(group &amp;&amp; group.length > 0) {
      sendMessage(sid);
    } else {
      // empty group
      process.nextTick(rpcCB(sid));
    }
  }
};

let restoreChannel = function(self, cb) {
  if(!self.store) {
    utils.invokeCallback(cb);
    return;
  } else {
    loadAllFromStore(self, genKey(self), function(err, list) {
      if(!!err) {
        utils.invokeCallback(cb, err);
        return;
      } else {
        if(!list.length || !Array.isArray(list)) {
          utils.invokeCallback(cb);
          return;
        }
        let load = function(key,name) {
          return (function() {
            loadAllFromStore(self, key, function(err, items) {
              for(let j=0; j&lt;items.length; j++) {
                let array = items[j].split(':');
                let sid = array[0];
                let uid = array[1];
                let channel = self.channels[name];
                let res = add(uid, sid, channel.groups);
                if(res) {
                  channel.records[uid] = {sid: sid, uid: uid};
                }
              }
            });
          })();
        };

       for(let i=0; i&lt;list.length; i++) {
        let name = list[i].slice(genKey(self).length + 1);
        self.channels[name] = new Channel(name, self);
        load(list[i],name);
      }
      utils.invokeCallback(cb);
    }
  });
}
};

let addToStore = function(self, key, value) {
  if(!!self.store) {
    self.store.add(key, value, function(err) {
      if(!!err) {
        logger.error('add key: %s value: %s to store, with err: %j', key, value, err.stack);
      }
    });
  }
};

let removeFromStore = function(self, key, value) {
  if(!!self.store) {
    self.store.remove(key, value, function(err) {
      if(!!err) {
        logger.error('remove key: %s value: %s from store, with err: %j', key, value, err.stack);
      }
    });
  }
};

let loadAllFromStore = function(self, key, cb) {
  if(!!self.store) {
    self.store.load(key, function(err, list) {
      if(!!err) {
        logger.error('load key: %s from store, with err: %j', key, err.stack);
        utils.invokeCallback(cb, err);
      } else {
        utils.invokeCallback(cb, null, list);
      }
    });
  }
};

let removeAllFromStore = function(self, key) {
  if(!!self.store) {
    self.store.removeAll(key, function(err) {
      if(!!err) {
        logger.error('remove key: %s all members from store, with err: %j', key, err.stack);
      }
    });
  }
};

let genKey = function(self, name) {
  if(!!name) {
    return self.prefix + ':' + self.app.serverId + ':' + name;
  } else {
    return self.prefix + ':' + self.app.serverId;
  }
};

let genValue = function(sid, uid) {
  return sid + ':' + uid;
};
</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="img/toast-ui.png" style="">
    <div class="footer-text">Sex-pomelo API doc</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
